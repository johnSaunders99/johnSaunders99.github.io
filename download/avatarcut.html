<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cutting Room For UBCAvatar</title>
    <link href="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.css" rel="stylesheet">
    <style>
        <!-- #photo { max-width: 100% } -->
        .img-preview { width: 100px; height: 100px; overflow: hidden }
        #selectImg { width: 500px; height: 500px }
    </style>
</head>
<body>
<form id="form">
    <!--表单部分-->
    <div>
        <span>
            <img src="" alt="裁剪结果" id="selectImg" style="display: none">
            <input type="file" id="imgInp" class="sr-only" style="display: none">
            <button type="button" class="pictureUrl" onclick="$('#imgInp').click()" id="uploadImg">choose</button>
            <p><button class="btn btn-success" onclick="download()">download</button></p>
        </span>
    </div>
</form>

<div id="cropperBox">
    <!--裁剪部分-->
    <div>
        <img src="" id="photo">
    </div>
    <!--预览-->
    <div class="img-preview"></div>
    <p><button class="btn btn-success" onclick="crop()">submit</button></p>
</div>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.js"></script>
<script>
    
    var initCropper = function (img, input){
        var $image = img;
        var options = {
            aspectRatio: 5 / 5,
            dragMode: 'move',
            viewMode: 2,
            cropBoxResizable: false,
            preview: '.img-preview'
        };
        $image.cropper(options);
        var $inputImage = input;
        var uploadedImageURL;
        if (URL) {
            $inputImage.change(function () {  // 给input添加监听
                $("#form").hide();
                $("#cropperBox").slideDown();
                var files = this.files;
                var file;
                if (!$image.data('cropper')) {
                    return;
                }
                if (files && files.length) {
                    file = files[0];
                    if (/^image\/\w+$/.test(file.type)) {   // 判断是否是图像文件
                        if (uploadedImageURL) {   // 如果URL已存在就先释放
                            URL.revokeObjectURL(uploadedImageURL);
                        }
                        uploadedImageURL = URL.createObjectURL(file);
                        // 销毁cropper后更改src属性再重新创建cropper
                        $image.cropper('destroy').attr('src', uploadedImageURL).cropper(options);
                        $inputImage.val('');
                    } else {
                        window.alert('请选择一个图像文件！');
                    }
                }
            });
        } else {
            $inputImage.prop('disabled', true).addClass('disabled');
        }
    };
    var crop = function(){
        var $image = $('#photo');
        var $target = $('#selectImg');
        $image.cropper('getCroppedCanvas',{
            width:500,
            height:500
        })        .toBlob(function(blob){
            $("#form").show();
            $("#cropperBox").slideUp();
            $("#selectImg").show();
            $target.attr('src', URL.createObjectURL(blob));    // 将裁剪后的图片放到指定标签
            var formData = new FormData();      // 将裁剪后的图片上传到服务器
            formData.append('croppedImage', blob);
        });
    };
    var download = function(){
        var $image = $('#photo');
        var $target = $('#selectImg');
        var url = $image.cropper('getCroppedCanvas',{
            width:500,
            height:500
        }).toDataURL('image/jpeg');
        var resultLink = document.createElement("a");
        resultLink.download = "for_ubisoft_avtar";
        resultLink.href = url;
        document.body.appendChild(resultLink);
        resultLink.click();
        resultLink.remove();
    }
    $(function(){
        initCropper($('#photo'),$('#imgInp'));
    });
</script>
</body>
</html>